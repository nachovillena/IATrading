# üîß Gu√≠a de Troubleshooting - Tests

## üö® Problemas Comunes y Soluciones

### 1. Import Errors

#### ‚ùå Error: `ImportError: cannot import name 'TradingConfig'`
```bash
ImportError: cannot import name 'TradingConfig' from 'src.core.config'
```

**üîç Causa:** Import de clase/funci√≥n que no existe
**‚úÖ Soluci√≥n:**
```python
# ‚ùå Incorrecto
from src.core.config import TradingConfig

# ‚úÖ Correcto - verificar qu√© existe realmente
from src.core.config.config_loader import ConfigLoader
```

**üõ†Ô∏è Debug Steps:**
```bash
# 1. Verificar qu√© hay en el m√≥dulo
python -c "import src.core.config; print(dir(src.core.config))"

# 2. Verificar estructura de archivos
ls -la src/core/config/

# 3. Ejecutar test espec√≠fico para verificar import
python -c "from src.core.types import TradingData; print('OK')"
```

#### ‚ùå Error: `ModuleNotFoundError: No module named 'src'`
```bash
ModuleNotFoundError: No module named 'src'
```

**üîç Causa:** Python no encuentra el m√≥dulo src
**‚úÖ Soluci√≥n:**
```bash
# 1. Verificar que est√°s en el directorio correcto
pwd  # Debe ser: /IATrading

# 2. Verificar que existe __init__.py en src/
ls src/__init__.py

# 3. Ejecutar pytest desde el directorio ra√≠z
python -m pytest tests/unit/test_core_additional.py -v
```

### 2. Test Failures

#### ‚ùå Error: `AssertionError: assert False`
```python
def test_strategy_signals(self):
    signals = strategy.generate_signals(data)
    assert len(signals.signals) > 0  # ‚ùå Falla porque no hay se√±ales
```

**üîç Causa:** La estrategia no genera se√±ales con los datos de test
**‚úÖ Soluci√≥n:**
```python
def test_strategy_signals(self):
    # ‚úÖ Crear datos que definitivamente generen se√±ales
    data = create_trending_data_with_crossover()
    signals = strategy.generate_signals(data)
    
    # ‚úÖ Verificaci√≥n m√°s robusta
    assert isinstance(signals, SignalData)
    assert len(signals.signals) >= 0  # Permitir 0 se√±ales
    assert signals.strategy_name is not None
```

#### ‚ùå Error: Tests intermitentes (Flaky Tests)
```python
def test_performance(self):
    start_time = time.time()
    strategy.generate_signals(data)
    execution_time = time.time() - start_time
    assert execution_time < 1.0  # ‚ùå Falla a veces por carga del sistema
```

**üîç Causa:** Dependencia en timing del sistema
**‚úÖ Soluci√≥n:**
```python
def test_performance(self):
    start_time = time.time()
    strategy.generate_signals(data)
    execution_time = time.time() - start_time
    
    # ‚úÖ Umbral m√°s tolerante o usar benchmark
    assert execution_time < 5.0  # M√°s tolerante
    print(f"‚ö° Execution time: {execution_time:.2f}s")
```

### 3. Coverage Issues

#### ‚ùå Error: `Coverage.py warning: No data was collected`
```bash
Coverage.py warning: No data was collected. (no-data-collected)
```

**üîç Causa:** Coverage no puede encontrar archivos para medir
**‚úÖ Soluci√≥n:**
```bash
# 1. Verificar que existe c√≥digo en src/
find src/ -name "*.py" | head -5

# 2. Ejecutar con path espec√≠fico
python -m pytest tests/ --cov=./src --cov-report=term-missing -v

# 3. Verificar configuraci√≥n en pytest.ini o .coveragerc
cat .coveragerc
```

#### ‚ùå Error: Coverage muy bajo inesperadamente
```bash
Coverage: 5% (expected ~35%)
```

**üîç Causa:** Solo midiendo archivos espec√≠ficos
**‚úÖ Soluci√≥n:**
```bash
# 1. Verificar qu√© archivos est√° midiendo coverage
python -m pytest --cov=src --cov-report=term-missing -v | grep "src/"

# 2. Ejecutar con todos los tests
python -m pytest tests/unit/ tests/integration/ --cov=src -v

# 3. Verificar exclusiones en .coveragerc
```

### 4. Performance Issues

#### ‚ùå Error: Tests muy lentos
```bash
Tests taking > 30 seconds
```

**üîç Causa:** Tests con datasets muy grandes o muchas repeticiones
**‚úÖ Soluci√≥n:**
```python
# ‚ùå Lento
def test_with_huge_dataset(self):
    data = create_data(100000)  # Muy grande
    
# ‚úÖ R√°pido pero efectivo
def test_with_reasonable_dataset(self):
    data = create_data(1000)    # Suficiente para test
    
# ‚úÖ Marcar tests lentos
@pytest.mark.slow
def test_large_dataset(self):
    data = create_data(100000)
```

```bash
# Ejecutar sin tests lentos
python -m pytest -m "not slow" -v
```

#### ‚ùå Error: Memory leak en tests
```python
def test_memory_usage(self):
    # Memory usage keeps growing
```

**‚úÖ Soluci√≥n:**
```python
def test_memory_usage(self):
    import gc
    
    for i in range(10):
        data = create_large_data()
        strategy = EMAStrategy()
        signals = strategy.generate_signals(data)
        
        # ‚úÖ Cleanup expl√≠cito
        del data, strategy, signals
        gc.collect()
```

### 5. Fixture Issues

#### ‚ùå Error: `fixture 'sample_data' not found`
```python
def test_with_fixture(self, sample_data):  # ‚ùå Fixture no encontrado
```

**üîç Causa:** Fixture no definido o no en scope correcto
**‚úÖ Soluci√≥n:**
```python
# 1. Definir fixture en conftest.py o en mismo archivo
@pytest.fixture
def sample_data():
    return create_test_data()

# 2. Verificar que conftest.py est√° en directorio correcto
tests/
‚îú‚îÄ‚îÄ conftest.py          # ‚úÖ Global fixtures
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py      # ‚úÖ Unit test fixtures
‚îÇ   ‚îî‚îÄ‚îÄ test_file.py
‚îî‚îÄ‚îÄ integration/
    ‚îî‚îÄ‚îÄ test_file.py
```

#### ‚ùå Error: Fixture con scope incorrecto
```python
@pytest.fixture(scope="session")  # ‚ùå Muy amplio
def database_connection():
    # Se reutiliza entre tests que deber√≠an ser independientes
```

**‚úÖ Soluci√≥n:**
```python
@pytest.fixture(scope="function")  # ‚úÖ Aislado por test
def clean_database():
    # Nueva instancia para cada test
    
@pytest.fixture(scope="session")   # ‚úÖ Solo para recursos costosos
def expensive_setup():
    # Solo cosas que realmente son costosas de crear
```

## üõ†Ô∏è Debugging Strategies

### 1. Debugging Test Individual
```bash
# 1. Ejecutar un test espec√≠fico con output
python -m pytest tests/unit/test_core_additional.py::TestStrategyManager::test_strategy_creation -v -s

# 2. Agregar prints para debugging
def test_debug_example(self):
    print(f"üîç Data shape: {data.shape}")
    print(f"üîç Strategy params: {strategy.parameters}")
    result = strategy.generate_signals(data)
    print(f"üîç Result: {result}")
    assert result is not None
```

### 2. Debugging con pdb
```python
def test_with_debugger(self):
    import pdb; pdb.set_trace()  # ‚úÖ Breakpoint
    
    data = create_test_data()
    strategy = EMAStrategy()
    signals = strategy.generate_signals(data)  # Examinar aqu√≠
    assert signals is not None
```

### 3. Debugging Coverage
```bash
# 1. Ver l√≠neas espec√≠ficas sin coverage
python -m pytest --cov=src.strategies --cov-report=term-missing -v

# 2. Generar reporte HTML detallado
python -m pytest --cov=src --cov-report=html:debug_coverage -v
# Abrir: debug_coverage/index.html

# 3. Ejecutar con coverage espec√≠fico
python -m pytest tests/unit/test_core_additional.py --cov=src.strategies.ema.strategy --cov-report=term-missing -v
```

## üö® Error Messages Comunes

### 1. Strategy Errors
```python
# ‚ùå Error com√∫n
InsufficientDataError: Strategy requires at least 26 periods

# ‚úÖ Fix
def test_strategy_with_sufficient_data(self):
    data = create_data_with_periods(50)  # > 26
    strategy = EMAStrategy({'ema_slow': 26})
    signals = strategy.generate_signals(data)
    assert signals is not None
```

### 2. Data Provider Errors
```python
# ‚ùå Error com√∫n
ConnectionError: Unable to connect to data provider

# ‚úÖ Fix con mock
@patch('requests.get')
def test_provider_with_mock(self, mock_get):
    mock_get.side_effect = ConnectionError()
    provider = YahooProvider()
    
    # Test que maneja el error gracefully
    data = provider.get_data('EURUSD')
    assert data is None  # Deber√≠a fallar gracefully
```

### 3. Threading Errors
```python
# ‚ùå Error com√∫n
RuntimeError: Thread safety violation

# ‚úÖ Fix con locks
import threading

def test_thread_safety(self):
    lock = threading.Lock()
    results = []
    
    def worker():
        with lock:
            strategy = EMAStrategy()
            # Thread-safe operations
```

## üìä Health Check Commands

### Quick Health Check
```bash
# 1. Test b√°sico - debe pasar
python -m pytest tests/unit/test_core_additional.py::TestCoreComponentsCoverage::test_orchestrator_comprehensive -v

# 2. Coverage check - debe ser ~35%
python -m pytest tests/unit/test_core_additional.py --cov=src --cov-report=term-missing -q

# 3. Integration check - debe pasar
python -m pytest tests/integration/test_system_integration.py::TestSystemIntegration::test_orchestrator_basic_functionality -v
```

### Comprehensive Health Check
```bash
# Sistema completo
python -m pytest tests/ --cov=src --cov-fail-under=33 -x  # Para en primer error

# Performance check
python -m pytest -k "performance" -v

# Memory check
python -m pytest -k "memory" -v
```

## üîß Environment Issues

### 1. Dependencies Missing
```bash
# ‚ùå Error: ModuleNotFoundError: No module named 'pandas'
pip install -r requirements.txt

# ‚ùå Error: ModuleNotFoundError: No module named 'pytest'
pip install pytest pytest-cov

# ‚úÖ Verificar dependencies
pip list | grep -E "(pytest|pandas|numpy)"
```

### 2. Python Version Issues
```bash
# ‚ùå Error: SyntaxError (Python version muy vieja)
python --version  # Debe ser 3.8+

# ‚úÖ Fix con Python correcto
python3.9 -m pytest tests/ -v
```

### 3. Path Issues
```bash
# ‚ùå Error: Tests no se encuentran
# Verificar estructura
find . -name "test_*.py" -type f

# ‚úÖ Configurar PYTHONPATH si necesario
export PYTHONPATH="${PYTHONPATH}:$(pwd)"
python -m pytest tests/ -v
```

## üìã Troubleshooting Checklist

### Antes de Ejecutar Tests
- [ ] Est√°s en el directorio correcto (IATrading/)
- [ ] Existe `src/__init__.py`
- [ ] Dependencies instaladas (`pip list`)
- [ ] Python version correcta (3.8+)

### Si Tests Fallan
- [ ] Leer el error message completo
- [ ] Verificar imports en el archivo de test
- [ ] Ejecutar test individual con `-v -s`
- [ ] Verificar que los datos de test son v√°lidos
- [ ] Comprobar que fixtures est√°n disponibles

### Si Coverage Es Bajo
- [ ] Ejecutar todos los tests (`tests/unit/` y `tests/integration/`)
- [ ] Verificar que `--cov=src` apunta al directorio correcto
- [ ] Comprobar exclusiones en `.coveragerc`
- [ ] Verificar que el c√≥digo se est√° ejecutando realmente

### Si Tests Son Lentos
- [ ] Identificar tests espec√≠ficos lentos
- [ ] Usar datasets m√°s peque√±os para tests unitarios
- [ ] Marcar tests lentos con `@pytest.mark.slow`
- [ ] Ejecutar con `-m "not slow"` durante desarrollo

## üÜò Cuando Todo Falla

### 1. Reset Completo
```bash
# 1. Limpiar cache
rm -rf .pytest_cache/
rm -rf __pycache__/
find . -name "*.pyc" -delete

# 2. Reinstalar dependencies
pip uninstall pytest pytest-cov -y
pip install pytest pytest-cov

# 3. Test simple
python -c "import src; print('Import OK')"
python -m pytest --version
```

### 2. Minimal Test
```python
# Crear test minimal para verificar setup
# tests/test_minimal.py
def test_minimal():
    assert True

def test_import():
    from src.core.types import TradingData
    assert TradingData is not None
```

```bash
python -m pytest tests/test_minimal.py -v
```

### 3. Pedir Ayuda
```bash
# 1. Generar info completa del error
python -m pytest tests/ -v --tb=long > error_log.txt 2>&1

# 2. Verificar versiones
python --version
pip list > requirements_current.txt

# 3. Estructura del proyecto
find . -name "*.py" | head -20 > project_structure.txt
```

**üìû Con esta informaci√≥n, puedes pedir ayuda espec√≠fica!**